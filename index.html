<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Schedule & Cost Breakdown Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 5px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 15px 20px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .tab:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            color: #495057;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-section {
            background: #fff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #e9ecef;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
        }

        .form-section h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            margin-right: 15px;
            border-radius: 2px;
        }

        .form-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: end;
        }

        .form-group input, .form-group select, .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #fff;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group .input-wrapper {
            flex: 1;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .list-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .list-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .work-item {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .work-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.1);
        }

        .work-item h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .section-total {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 600;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .export-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }

        .export-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .currency {
            color: #28a745;
            font-weight: 600;
        }

        .total-summary {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.3);
        }

        .total-summary h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .role-template-item {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .role-template-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.1);
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
            color: #1565c0;
        }

        @media (max-width: 768px) {
            .form-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Work Schedule & Cost Breakdown</h1>
            <p>Create professional work schedules with automatic cost calculations</p>
        </div>

        <div class="main-content">
            <div class="tabs">
                <button class="tab active" onclick="showTab('roles')">Role Templates</button>
                <button class="tab" onclick="showTab('people')">Team Members</button>
                <button class="tab" onclick="showTab('work')">Work Breakdown</button>
                <button class="tab" onclick="showTab('export')">Export</button>
            </div>

            <!-- Role Templates Tab -->
            <div id="roles-tab" class="tab-content active">
                <div class="info-box">
                    <strong>First time setup:</strong> Create your standard roles here with their day rates. Once set up, you can quickly add team members by selecting these roles.
                </div>

                <div class="form-section">
                    <h3>Add Role Template</h3>
                    <div class="form-group">
                        <div class="input-wrapper">
                            <label for="role-name">Role Name</label>
                            <input type="text" id="role-name" placeholder="e.g., Senior Consultant">
                        </div>
                        <div class="input-wrapper">
                            <label for="role-rate">Standard Day Rate (Â£)</label>
                            <input type="number" id="role-rate" placeholder="0.00" step="0.01">
                        </div>
                        <button class="btn" onclick="addRoleTemplate()">Add Role</button>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Role Templates</h3>
                    <div id="role-templates-list"></div>
                </div>

                <div class="form-section">
                    <h3>Bulk Rate Update</h3>
                    <p style="color: #6c757d; margin-bottom: 15px;">Update all role rates by a percentage (e.g., for annual increases)</p>
                    <div class="form-group">
                        <div class="input-wrapper">
                            <label for="rate-increase">Percentage Change (%)</label>
                            <input type="number" id="rate-increase" placeholder="e.g., 5 for 5% increase" step="0.1">
                        </div>
                        <button class="btn btn-success" onclick="bulkUpdateRates()">Update All Rates</button>
                    </div>
                </div>
            </div>

            <!-- People Tab -->
            <div id="people-tab" class="tab-content">
                <div class="form-section">
                    <h3>Add Team Member</h3>
                    <div class="form-group">
                        <div class="input-wrapper">
                            <label for="person-template">Select Role Template (Optional)</label>
                            <select id="person-template" onchange="fillFromTemplate()">
                                <option value="">-- Select a role template --</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="input-wrapper">
                            <label for="person-name">Name</label>
                            <input type="text" id="person-name" placeholder="Enter name">
                        </div>
                        <div class="input-wrapper">
                            <label for="person-role">Role</label>
                            <input type="text" id="person-role" placeholder="Enter role">
                        </div>
                        <div class="input-wrapper">
                            <label for="person-rate">Day Rate (Â£)</label>
                            <input type="number" id="person-rate" placeholder="0.00" step="0.01">
                        </div>
                        <button class="btn" onclick="addPerson()">Add Person</button>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Team Members</h3>
                    <div id="people-list"></div>
                </div>
            </div>

            <!-- Work Tab -->
            <div id="work-tab" class="tab-content">
                <div class="form-section">
                    <h3>Import Structure from Excel</h3>
                    <p style="color: #6c757d; margin-bottom: 15px;">Copy sections and work items from Excel and paste them here. Sections should be in the left column, work items indented in the right column.</p>
                    <div class="form-group" style="flex-direction: column; align-items: stretch;">
                        <div class="input-wrapper">
                            <label for="import-text">Paste Excel Structure Here</label>
                            <textarea id="import-text" rows="8" 
                                placeholder="Paste your Excel structure here. For example:&#10;Section 1&#10;&#9;Work item 1&#10;&#9;Work item 2&#10;Section 2&#10;&#9;Work item 3"
                                style="width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; font-family: monospace; resize: vertical;"></textarea>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="previewImport()">Preview Structure</button>
                            <button class="btn" onclick="importStructure()">Import Structure</button>
                            <button class="btn btn-secondary" onclick="clearImport()">Clear</button>
                        </div>
                    </div>
                    
                    <!-- Preview area -->
                    <div id="import-preview" style="display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e9ecef;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">Preview - This will be created:</h4>
                        <div id="preview-content"></div>
                        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; color: #856404;">
                            <strong>Note:</strong> Work items will be created without team member assignments. You'll need to assign people and days after import.
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Or Create Section Manually</h3>
                    <div class="form-group">
                        <div class="input-wrapper">
                            <label for="new-section-name">Section Name</label>
                            <input type="text" id="new-section-name" placeholder="e.g., Planning, Development, Testing">
                        </div>
                        <button class="btn" onclick="createSection()">Create Section</button>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Work Breakdown</h3>
                    <div id="sections-list"></div>
                    <div class="total-summary">
                        <h3>Total Project Cost: <span id="total-cost">Â£0.00</span></h3>
                        <p>Total Days: <span id="total-days">0.0</span></p>
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div id="export-tab" class="tab-content">
                <div class="export-section">
                    <h3>Export to Excel</h3>
                    <p>Download your work breakdown as a CSV file that can be opened in Excel</p>
                    <br>
                    <button class="btn" onclick="exportToCSV()">Download CSV File</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let people = [];
        let workItems = [];
        let sections = [];
        let roleTemplates = [];

        // Load saved data on startup
        window.addEventListener('load', function() {
            loadRoleTemplates();
            updateRoleTemplatesList();
            updateRoleTemplateDropdown();
        });

        // Save role templates to localStorage
        function saveRoleTemplates() {
            localStorage.setItem('workScheduleRoleTemplates', JSON.stringify(roleTemplates));
        }

        // Load role templates from localStorage
        function loadRoleTemplates() {
            const saved = localStorage.getItem('workScheduleRoleTemplates');
            if (saved) {
                roleTemplates = JSON.parse(saved);
            } else {
                // Default templates if none exist
                roleTemplates = [
                    { id: Date.now(), name: 'Senior Consultant', rate: 650 },
                    { id: Date.now() + 1, name: 'Junior Consultant', rate: 450 },
                    { id: Date.now() + 2, name: 'Project Manager', rate: 550 },
                    { id: Date.now() + 3, name: 'Business Analyst', rate: 500 }
                ];
                saveRoleTemplates();
            }
        }

        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // Role Template functions
        function addRoleTemplate() {
            const name = document.getElementById('role-name').value.trim();
            const rate = parseFloat(document.getElementById('role-rate').value);

            if (!name || !rate) {
                alert('Please fill in all fields');
                return;
            }

            const roleTemplate = {
                id: Date.now(),
                name: name,
                rate: rate
            };

            roleTemplates.push(roleTemplate);
            saveRoleTemplates();
            updateRoleTemplatesList();
            updateRoleTemplateDropdown();

            // Clear form
            document.getElementById('role-name').value = '';
            document.getElementById('role-rate').value = '';
        }

        function removeRoleTemplate(id) {
            roleTemplates = roleTemplates.filter(template => template.id !== id);
            saveRoleTemplates();
            updateRoleTemplatesList();
            updateRoleTemplateDropdown();
        }

        function editRoleTemplate(id) {
            const template = roleTemplates.find(t => t.id === id);
            if (!template) return;

            const newRate = prompt(`Enter new day rate for ${template.name}:`, template.rate);
            if (newRate && !isNaN(parseFloat(newRate))) {
                template.rate = parseFloat(newRate);
                saveRoleTemplates();
                updateRoleTemplatesList();
                updateRoleTemplateDropdown();
            }
        }

        function updateRoleTemplatesList() {
            const list = document.getElementById('role-templates-list');
            list.innerHTML = '';

            if (roleTemplates.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">No role templates yet. Add some above!</p>';
                return;
            }

            roleTemplates.forEach(template => {
                const item = document.createElement('div');
                item.className = 'role-template-item';
                item.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="font-size: 1.1em;">${template.name}</strong>
                            <br><span class="currency">Â£${template.rate.toFixed(2)}/day</span>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="editRoleTemplate(${template.id})" style="padding: 8px 16px; font-size: 14px;">Edit Rate</button>
                            <button class="btn btn-danger" onclick="removeRoleTemplate(${template.id})" style="padding: 8px 16px; font-size: 14px;">Remove</button>
                        </div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function updateRoleTemplateDropdown() {
            const dropdown = document.getElementById('person-template');
            dropdown.innerHTML = '<option value="">-- Select a role template --</option>';
            
            roleTemplates.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = `${template.name} - Â£${template.rate.toFixed(2)}/day`;
                dropdown.appendChild(option);
            });
        }

        function fillFromTemplate() {
            const templateId = document.getElementById('person-template').value;
            if (!templateId) {
                // Clear fields if no template selected
                document.getElementById('person-role').value = '';
                document.getElementById('person-rate').value = '';
                return;
            }

            const template = roleTemplates.find(t => t.id === parseInt(templateId));
            if (template) {
                document.getElementById('person-role').value = template.name;
                document.getElementById('person-rate').value = template.rate;
            }
        }

        function bulkUpdateRates() {
            const percentage = parseFloat(document.getElementById('rate-increase').value);
            if (isNaN(percentage)) {
                alert('Please enter a valid percentage');
                return;
            }

            const multiplier = 1 + (percentage / 100);
            roleTemplates.forEach(template => {
                template.rate = Math.round(template.rate * multiplier * 100) / 100; // Round to 2 decimal places
            });

            saveRoleTemplates();
            updateRoleTemplatesList();
            updateRoleTemplateDropdown();
            
            alert(`All rates updated by ${percentage}%`);
            document.getElementById('rate-increase').value = '';
        }

        // Original functions continue below...
        function addPerson() {
            const name = document.getElementById('person-name').value.trim();
            const role = document.getElementById('person-role').value.trim();
            const rate = parseFloat(document.getElementById('person-rate').value);

            if (!name || !role || !rate) {
                alert('Please fill in all fields');
                return;
            }

            const person = {
                id: Date.now(),
                name: name,
                role: role,
                rate: rate
            };

            people.push(person);
            updatePeopleList();
            updateSectionsList();
            
            // Clear form
            document.getElementById('person-name').value = '';
            document.getElementById('person-role').value = '';
            document.getElementById('person-rate').value = '';
            document.getElementById('person-template').value = '';
        }

        function removePerson(id) {
            people = people.filter(person => person.id !== id);
            updatePeopleList();
            updateSectionsList();
        }

        function updatePeopleList() {
            const list = document.getElementById('people-list');
            list.innerHTML = '';

            people.forEach(person => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <div>
                        <strong>${person.name}</strong> - ${person.role}
                        <br><span class="currency">Â£${person.rate.toFixed(2)}/day</span>
                    </div>
                    <button class="btn btn-danger" onclick="removePerson(${person.id})">Remove</button>
                `;
                list.appendChild(item);
            });
        }

        function previewImport() {
            const text = document.getElementById('import-text').value.trim();
            
            if (!text) {
                alert('Please paste some text to preview');
                return;
            }
            
            const parsed = parseImportText(text);
            
            if (parsed.sections.length === 0) {
                alert('No valid structure detected. Make sure sections are in the left column and work items are indented (tabbed) in the right column.');
                return;
            }
            
            // Show preview
            const previewDiv = document.getElementById('import-preview');
            const contentDiv = document.getElementById('preview-content');
            
            let previewHtml = '';
            parsed.sections.forEach(section => {
                previewHtml += `<div style="margin-bottom: 15px;">`;
                previewHtml += `<strong style="color: #2c3e50; font-size: 1.1em;">${section.name}</strong>`;
                if (section.workItems.length > 0) {
                    previewHtml += `<ul style="margin: 8px 0 0 20px; color: #6c757d;">`;
                    section.workItems.forEach(workItem => {
                        previewHtml += `<li>${workItem}</li>`;
                    });
                    previewHtml += `</ul>`;
                } else {
                    previewHtml += `<div style="margin-left: 20px; color: #6c757d; font-style: italic;">No work items</div>`;
                }
                previewHtml += `</div>`;
            });
            
            contentDiv.innerHTML = previewHtml;
            previewDiv.style.display = 'block';
        }

        function parseImportText(text) {
            const lines = text.split('\n').map(line => line.replace(/\r/g, ''));
            const sections = [];
            let currentSection = null;
            
            lines.forEach(line => {
                if (!line.trim()) return;
                
                if (line.match(/^\s+/)) {
                    const workItem = line.trim();
                    if (currentSection && workItem) {
                        currentSection.workItems.push(workItem);
                    }
                } else {
                    const sectionName = line.trim();
                    if (sectionName) {
                        currentSection = {
                            name: sectionName,
                            workItems: []
                        };
                        sections.push(currentSection);
                    }
                }
            });
            
            return { sections };
        }

        function importStructure() {
            const text = document.getElementById('import-text').value.trim();
            
            if (!text) {
                alert('Please paste some text to import');
                return;
            }
            
            const parsed = parseImportText(text);
            
            if (parsed.sections.length === 0) {
                alert('No valid structure detected. Make sure sections are in the left column and work items are indented (tabbed) in the right column.');
                return;
            }
            
            let addedSections = 0;
            let skippedSections = 0;
            
            parsed.sections.forEach(parsedSection => {
                if (!sections.includes(parsedSection.name)) {
                    sections.push(parsedSection.name);
                    addedSections++;
                } else {
                    skippedSections++;
                }
            });
            
            parsed.sections.forEach(parsedSection => {
                parsedSection.workItems.forEach(workItemName => {
                    const existingWorkItem = workItems.find(item => 
                        item.section === parsedSection.name && 
                        item.description === workItemName
                    );
                    
                    if (!existingWorkItem) {
                        const placeholderWorkItem = {
                            id: Date.now() + Math.random(),
                            section: parsedSection.name,
                            description: workItemName,
                            personId: null,
                            personName: 'Unassigned',
                            personRole: '',
                            personRate: 0,
                            days: 0,
                            cost: 0,
                            isPlaceholder: true
                        };
                        workItems.push(placeholderWorkItem);
                    }
                });
            });
            
            updateSectionsList();
            updateTotals();
            
            document.getElementById('import-preview').style.display = 'none';
            document.getElementById('import-text').value = '';
            
            let message = `Import complete!\n${addedSections} sections created`;
            if (skippedSections > 0) {
                message += `\n${skippedSections} sections skipped (already exist)`;
            }
            message += `\n\nNow assign team members and days to the work items.`;
            alert(message);
        }

        function clearImport() {
            document.getElementById('import-text').value = '';
            document.getElementById('import-preview').style.display = 'none';
        }

        function createSection() {
            const sectionName = document.getElementById('new-section-name').value.trim();
            
            if (!sectionName) {
                alert('Please enter a section name');
                return;
            }
            
            if (sections.includes(sectionName)) {
                alert('Section already exists');
                return;
            }
            
            sections.push(sectionName);
            updateSectionsList();
            
            document.getElementById('new-section-name').value = '';
        }

        function removeSection(sectionName) {
            sections = sections.filter(s => s !== sectionName);
            workItems = workItems.filter(item => item.section !== sectionName);
            
            updateSectionsList();
            updateTotals();
        }

        function updateSectionsList() {
            const list = document.getElementById('sections-list');
            list.innerHTML = '';

            if (sections.length === 0) {
                list.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">Create sections above to start building your work breakdown</p>';
                return;
            }

            sections.forEach(sectionName => {
                const sectionContainer = document.createElement('div');
                sectionContainer.style.marginBottom = '30px';
                
                const sectionHeader = document.createElement('div');
                sectionHeader.style.display = 'flex';
                sectionHeader.style.justifyContent = 'space-between';
                sectionHeader.style.alignItems = 'center';
                sectionHeader.style.marginBottom = '15px';
                sectionHeader.innerHTML = `
                    <h4 style="color: #2c3e50; margin: 0; font-size: 1.3em;">${sectionName}</h4>
                    <button class="btn btn-danger" onclick="removeSection('${sectionName}')" style="padding: 8px 16px; font-size: 14px;">Remove Section</button>
                `;
                sectionContainer.appendChild(sectionHeader);

                const sectionWorkItems = workItems.filter(item => item.section === sectionName);
                
                const workItemGroups = {};
                sectionWorkItems.forEach(item => {
                    if (!workItemGroups[item.description]) {
                        workItemGroups[item.description] = [];
                    }
                    workItemGroups[item.description].push(item);
                });

                let sectionTotalDays = 0;
                let sectionTotalCost = 0;

                Object.keys(workItemGroups).forEach(description => {
                    const workGroup = workItemGroups[description];
                    const workDiv = document.createElement('div');
                    workDiv.className = 'work-item';
                    
                    let groupTotalDays = 0;
                    let groupTotalCost = 0;
                    
                    const hasPlaceholder = workGroup.some(item => item.isPlaceholder);
                    
                    let assignmentsHtml = '';
                    workGroup.forEach(item => {
                        if (item.isPlaceholder) {
                            assignmentsHtml += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f4; background: #fff3cd; margin: 2px 0; border-radius: 4px; padding: 8px;">
                                    <span style="color: #856404; font-style: italic;">â ï¸ Unassigned - please assign team member and days</span>
                                    <button class="btn btn-danger" onclick="removeWorkItem(${item.id})" style="padding: 4px 8px; font-size: 12px;">Remove</button>
                                </div>
                            `;
                        } else {
                            groupTotalDays += item.days;
                            groupTotalCost += item.cost;
                            sectionTotalDays += item.days;
                            sectionTotalCost += item.cost;
                            
                            assignmentsHtml += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f1f3f4;">
                                    <span style="color: #6c757d;">${item.personName} (${item.personRole}) - 
                                        <span id="days-display-${item.id}">${item.days} days</span> Ã Â£${item.personRate.toFixed(2)} = 
                                        <span id="cost-display-${item.id}">Â£${item.cost.toFixed(2)}</span>
                                    </span>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-secondary" onclick="editWorkItem(${item.id})" style="padding: 4px 8px; font-size: 12px;">Edit</button>
                                        <button class="btn btn-danger" onclick="removeWorkItem(${item.id})" style="padding: 4px 8px; font-size: 12px;">Remove</button>
                                    </div>
                                </div>
                                <div id="edit-form-${item.id}" style="display: none; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 10px 0;">
                                    <div style="margin-bottom: 10px; font-weight: 600; color: #856404;">
                                        Edit ${item.personName}'s assignment to "${description}"
                                    </div>
                                    <div style="display: flex; gap: 10px; align-items: end;">
                                        <div style="flex: 1;">
                                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 14px;">Days</label>
                                            <input type="number" step="0.1" value="${item.days}" 
                                                   style="width: 100%; padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;"
                                                   id="edit-days-${item.id}">
                                        </div>
                                        <button class="btn" onclick="saveWorkItemEdit(${item.id})" style="padding: 8px 16px; font-size: 14px;">Save</button>
                                        <button class="btn btn-secondary" onclick="cancelWorkItemEdit(${item.id})" style="padding: 8px 16px; font-size: 14px;">Cancel</button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                    
                    const assignedPersonIds = workGroup.filter(item => !item.isPlaceholder).map(item => item.personId);
                    const availablePeople = people.filter(person => !assignedPersonIds.includes(person.id));
                    
                    workDiv.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <strong style="font-size: 1.1em;">${description}</strong>
                                <span class="currency" style="font-weight: 600;">Total: ${groupTotalDays.toFixed(1)} days - Â£${groupTotalCost.toFixed(2)}</span>
                            </div>
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 10px; margin-bottom: 15px;">
                                ${assignmentsHtml}
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 8px; padding: 15px; ${availablePeople.length === 0 ? 'display: none;' : ''}">
                            <div style="margin-bottom: 10px; font-weight: 600; color: #6c757d; font-size: 14px;">
                                + Add person to "${description}"
                            </div>
                            <div style="display: flex; gap: 10px; align-items: end;">
                                <div style="flex: 1;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 14px;">Person</label>
                                    <select style="width: 100%; padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;"
                                            id="add-person-${sectionName.replace(/\s+/g, '-')}-${description.replace(/\s+/g, '-')}">
                                        <option value="">Select person...</option>
                                        ${availablePeople.map(person => `<option value="${person.id}">${person.name} (${person.role})</option>`).join('')}
                                    </select>
                                </div>
                                <div style="flex: 0.5;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 14px;">Days</label>
                                    <input type="number" placeholder="0.0" step="0.1" 
                                           style="width: 100%; padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;"
                                           id="add-days-${sectionName.replace(/\s+/g, '-')}-${description.replace(/\s+/g, '-')}">
                                </div>
                                <button class="btn" onclick="addPersonToWorkItem('${sectionName}', '${description}')" 
                                        style="padding: 8px 16px; font-size: 14px;">
                                    Add Person
                                </button>
                            </div>
                        </div>
                        ${availablePeople.length === 0 ? '<div style="background: #e9ecef; border-radius: 8px; padding: 15px; text-align: center; color: #6c757d; font-style: italic;">All team members have been assigned to this work item</div>' : ''}
                    `;
                    sectionContainer.appendChild(workDiv);
                });

                const quickAddDiv = document.createElement('div');
                quickAddDiv.className = 'work-item';
                quickAddDiv.style.background = '#f0f8ff';
                quickAddDiv.style.border = '2px dashed #007bff';
                quickAddDiv.innerHTML = `
                    <div style="margin-bottom: 15px; font-weight: 600; color: #007bff;">
                        + Add new work item to ${sectionName}
                    </div>
                    <div style="display: flex; gap: 10px; align-items: end; flex-wrap: wrap;">
                        <div style="flex: 2; min-width: 200px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 14px;">Work Item Description</label>
                            <input type="text" placeholder="Describe the work to be done" 
                                   style="width: 100%; padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;"
                                   id="new-work-desc-${sectionName.replace(/\s+/g, '-')}">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 14px;">First Person</label>
                            <select style="width: 100%; padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;"
                                    id="new-work-person-${sectionName.replace(/\s+/g, '-')}">
                                <option value="">Select person...</option>
                                ${people.map(person => `<option value="${person.id}">${person.name} (${person.role})</option>`).join('')}
                            </select>
                        </div>
                        <div style="flex: 0.5; min-width: 80px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057; font-size: 14px;">Days</label>
                            <input type="number" placeholder="0.0" step="0.1" 
                                   style="width: 100%; padding: 8px 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;"
                                   id="new-work-days-${sectionName.replace(/\s+/g, '-')}">
                        </div>
                        <button class="btn" onclick="addNewWorkItem('${sectionName}')" 
                                style="padding: 8px 16px; font-size: 14px; min-width: 100px;">
                            Create Work Item
                        </button>
                    </div>
                `;
                sectionContainer.appendChild(quickAddDiv);

                const totalDiv = document.createElement('div');
                totalDiv.className = 'section-total';
                totalDiv.innerHTML = `${sectionName} Total: ${sectionTotalDays.toFixed(1)} days - Â£${sectionTotalCost.toFixed(2)}`;
                sectionContainer.appendChild(totalDiv);

                list.appendChild(sectionContainer);
            });
        }

        function addNewWorkItem(sectionName) {
            const sectionId = sectionName.replace(/\s+/g, '-');
            const description = document.getElementById(`new-work-desc-${sectionId}`).value.trim();
            const personId = parseInt(document.getElementById(`new-work-person-${sectionId}`).value);
            const days = parseFloat(document.getElementById(`new-work-days-${sectionId}`).value);

            if (!description || !personId || !days) {
                alert('Please fill in all fields');
                return;
            }

            const person = people.find(p => p.id === personId);
            const cost = days * person.rate;

            const workItem = {
                id: Date.now(),
                section: sectionName,
                description: description,
                personId: personId,
                personName: person.name,
                personRole: person.role,
                personRate: person.rate,
                days: days,
                cost: cost
            };

            workItems.push(workItem);
            updateSectionsList();
            updateTotals();
        }

        function addPersonToWorkItem(sectionName, description) {
            const sectionId = sectionName.replace(/\s+/g, '-');
            const descId = description.replace(/\s+/g, '-');
            const personId = parseInt(document.getElementById(`add-person-${sectionId}-${descId}`).value);
            const days = parseFloat(document.getElementById(`add-days-${sectionId}-${descId}`).value);

            if (!personId || !days) {
                alert('Please select a person and enter days');
                return;
            }

            const person = people.find(p => p.id === personId);
            const cost = days * person.rate;

            const workItem = {
                id: Date.now(),
                section: sectionName,
                description: description,
                personId: personId,
                personName: person.name,
                personRole: person.role,
                personRate: person.rate,
                days: days,
                cost: cost
            };

            workItems.push(workItem);
            updateSectionsList();
            updateTotals();
        }

        function editWorkItem(id) {
            document.getElementById(`edit-form-${id}`).style.display = 'block';
        }

        function saveWorkItemEdit(id) {
            const newDays = parseFloat(document.getElementById(`edit-days-${id}`).value);
            
            if (!newDays || newDays <= 0) {
                alert('Please enter a valid number of days');
                return;
            }

            const workItem = workItems.find(item => item.id === id);
            if (workItem) {
                workItem.days = newDays;
                workItem.cost = newDays * workItem.personRate;
                
                updateSectionsList();
                updateTotals();
            }
        }

        function cancelWorkItemEdit(id) {
            document.getElementById(`edit-form-${id}`).style.display = 'none';
        }

        function removeWorkItem(id) {
            workItems = workItems.filter(item => item.id !== id);
            updateSectionsList();
            updateTotals();
        }

        function updateTotals() {
            const totalDays = workItems.reduce((sum, item) => sum + item.days, 0);
            const totalCost = workItems.reduce((sum, item) => sum + item.cost, 0);

            document.getElementById('total-days').textContent = totalDays.toFixed(1);
            document.getElementById('total-cost').textContent = `Â£${totalCost.toFixed(2)}`;
        }

        function exportToCSV() {
            if (workItems.length === 0) {
                alert('No work items to export');
                return;
            }

            try {
                const allPeople = [...new Set(workItems.map(item => item.personId))].map(id => 
                    people.find(p => p.id === id)
                ).filter(Boolean);
                
                const sections = {};
                workItems.forEach(item => {
                    if (!sections[item.section]) {
                        sections[item.section] = {};
                    }
                    if (!sections[item.section][item.description]) {
                        sections[item.section][item.description] = {};
                    }
                    sections[item.section][item.description][item.personId] = item;
                });

                let csv = '';
                
                csv += 'Item,Activity';
                allPeople.forEach(person => {
                    csv += `,${person.name}`;
                });
                csv += ',Total Days (by activity),Total Fees (by activity),Payment Plan\n';
                
                csv += ',';
                allPeople.forEach(person => {
                    csv += `,${person.role}`;
                });
                csv += ',,\n';
                
                csv += ',';
                allPeople.forEach(person => {
                    csv += `,Â£${person.rate.toFixed(2)}`;
                });
                csv += ',,\n';

                let overallItemCounter = 1;
                
                Object.keys(sections).forEach(sectionName => {
                    let sectionTotalDays = 0;
                    let sectionTotalCost = 0;
                    
                    Object.keys(sections[sectionName]).forEach(description => {
                        const activities = sections[sectionName][description];
                        let rowTotalDays = 0;
                        let rowTotalCost = 0;
                        
                        csv += `${overallItemCounter},${description}`;
                        
                        allPeople.forEach(person => {
                            const workItem = activities[person.id];
                            if (workItem) {
                                csv += `,${workItem.days.toFixed(1)}`;
                                rowTotalDays += workItem.days;
                                rowTotalCost += workItem.cost;
                            } else {
                                csv += ',';
                            }
                        });
                        
                        csv += `,${rowTotalDays.toFixed(1)},Â£${rowTotalCost.toFixed(2)},\n`;
                        
                        sectionTotalDays += rowTotalDays;
                        sectionTotalCost += rowTotalCost;
                        overallItemCounter++;
                    });
                    
                    csv += `TOTAL,`;
                    allPeople.forEach(person => {
                        let personSectionDays = 0;
                        Object.values(sections[sectionName]).forEach(activities => {
                            const workItem = activities[person.id];
                            if (workItem) {
                                personSectionDays += workItem.days;
                            }
                        });
                        csv += `,${personSectionDays > 0 ? personSectionDays.toFixed(1) : ''}`;
                    });
                    csv += `,${sectionTotalDays.toFixed(1)},Â£${sectionTotalCost.toFixed(2)},\n`;
                    
                    csv += '\n';
                });
                
                csv += 'OVERALL TOTAL,';
                allPeople.forEach(person => {
                    let personTotalDays = 0;
                    workItems.forEach(item => {
                        if (item.personId === person.id) {
                            personTotalDays += item.days;
                        }
                    });
                    csv += `,${personTotalDays > 0 ? personTotalDays.toFixed(1) : ''}`;
                });
                
                const grandTotalDays = workItems.reduce((sum, item) => sum + item.days, 0);
                const grandTotalCost = workItems.reduce((sum, item) => sum + item.cost, 0);
                csv += `,${grandTotalDays.toFixed(1)},Â£${grandTotalCost.toFixed(2)},\n`;
                
                csv += '\n';
                csv += 'Total Days (by individual):,';
                allPeople.forEach(person => {
                    let personTotalDays = 0;
                    workItems.forEach(item => {
                        if (item.personId === person.id) {
                            personTotalDays += item.days;
                        }
                    });
                    csv += `,${personTotalDays.toFixed(1)}`;
                });
                csv += `,${grandTotalDays.toFixed(1)},\n`;
                
                csv += 'Total Fees (by individual):,';
                allPeople.forEach(person => {
                    let personTotalCost = 0;
                    workItems.forEach(item => {
                        if (item.personId === person.id) {
                            personTotalCost += item.cost;
                        }
                    });
                    csv += `,Â£${personTotalCost.toFixed(2)}`;
                });
                csv += `,Â£${grandTotalCost.toFixed(2)},\n`;

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                
                if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                    window.navigator.msSaveOrOpenBlob(blob, 'work_schedule_' + new Date().toISOString().split('T')[0] + '.csv');
                } else {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'work_schedule_' + new Date().toISOString().split('T')[0] + '.csv';
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 100);
                }

                alert('CSV file downloaded successfully!');

            } catch (error) {
                console.error('Export error:', error);
                alert('There was an error exporting the file. Please try again.');
            }
        }
    </script>
</body>
</html>